"use strict";(self.webpackChunkcow_docs=self.webpackChunkcow_docs||[]).push([[6128],{3905:(e,t,r)=>{r.d(t,{Zo:()=>d,kt:()=>f});var a=r(7294);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?n(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,a,o=function(e,t){if(null==e)return{};var r,a,o={},n=Object.keys(e);for(a=0;a<n.length;a++)r=n[a],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(a=0;a<n.length;a++)r=n[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var s=a.createContext({}),c=function(e){var t=a.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},d=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var r=e.components,o=e.mdxType,n=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=c(r),m=o,f=u["".concat(s,".").concat(m)]||u[m]||p[m]||n;return r?a.createElement(f,i(i({ref:t},d),{},{components:r})):a.createElement(f,i({ref:t},d))}));function f(e,t){var r=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var n=r.length,i=new Array(n);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:o,i[1]=l;for(var c=2;c<n;c++)i[c]=r[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,r)}m.displayName="MDXCreateElement"},4778:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>n,metadata:()=>l,toc:()=>c});var a=r(7462),o=(r(7294),r(3905));const n={},i="Smart Contract Wallet Orders",l={unversionedId:"tutorials/how-to-place-erc-1271-smart-contract-orders/smart-contract-wallet-orders",id:"tutorials/how-to-place-erc-1271-smart-contract-orders/smart-contract-wallet-orders",title:"Smart Contract Wallet Orders",description:"The spirit of ERC-1271 support in CoW Protocol was to enable Smart Contract wallets like to be able to trade on CoW Protocol and CoW Swap. Each individual Smart Contract wallet would then be able to implement their own signature validation scheme, for example:",source:"@site/docs/5_tutorials/how-to-place-erc-1271-smart-contract-orders/4_smart-contract-wallet-orders.md",sourceDirName:"5_tutorials/how-to-place-erc-1271-smart-contract-orders",slug:"/tutorials/how-to-place-erc-1271-smart-contract-orders/smart-contract-wallet-orders",permalink:"/cow-docs/docs/tutorials/how-to-place-erc-1271-smart-contract-orders/smart-contract-wallet-orders",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/5_tutorials/how-to-place-erc-1271-smart-contract-orders/4_smart-contract-wallet-orders.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"The Basics of ERC-1271",permalink:"/cow-docs/docs/tutorials/how-to-place-erc-1271-smart-contract-orders/the-basics-of-erc-1271"},next:{title:"Smart Orders",permalink:"/cow-docs/docs/tutorials/how-to-place-erc-1271-smart-contract-orders/smart-orders"}},s={},c=[{value:"Safe",id:"safe",level:3}],d={toc:c},u="wrapper";function p(e){let{components:t,...r}=e;return(0,o.kt)(u,(0,a.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"smart-contract-wallet-orders"},"Smart Contract Wallet Orders"),(0,o.kt)("p",null,"The spirit of ERC-1271 support in CoW Protocol was to enable Smart Contract wallets like to be able to trade on CoW Protocol and CoW Swap. Each individual Smart Contract wallet would then be able to implement their own signature validation scheme, for example:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Wallet owner indicates that some hash is trusted by executing an on-chain transaction"),(0,o.kt)("li",{parentName:"ul"},"Wallet accepts all signatures from a specific domain"),(0,o.kt)("li",{parentName:"ul"},"Owner off-chain signatures that are verified by the Smart Contract wallet")),(0,o.kt)("p",null,"Specifically, the Safe v1.3 uses the latter for verifying signatures. Because the Safe uses off-chain owner ECDSA signatures for signature verification, this means that it is possible to trade gas-less on CoW Protocol with the Safe."),(0,o.kt)("h3",{id:"safe"},"Safe"),(0,o.kt)("p",null,"Safe signature verification is done on a special EIP-712 ",(0,o.kt)("inlineCode",{parentName:"p"},"SafeMessage"),". This just wraps the same order digest that we used before for both ECDSA and ERC-1271 signature verification. This makes the process very similar to what we had before for EOAs:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Like before, prepare your order, i.e. the structured order data"),(0,o.kt)("li",{parentName:"ol"},"Like before, hash this structured data into a 32-byte digest"),(0,o.kt)("li",{parentName:"ol"},'Unlike before, we "wrap" this digest in a ',(0,o.kt)("inlineCode",{parentName:"li"},"SafeMessage")),(0,o.kt)("li",{parentName:"ol"},"Like before, we generate an ECDSA signature with our EOA's private key")),(0,o.kt)("p",null,"![](/img/image (4).png)"),(0,o.kt)("p",null,"For multi-owner Safes, you would just collect a bunch of these signatures and concatenate them together."),(0,o.kt)("p",null,"![](/img/image (5).png)"),(0,o.kt)("p",null,"For verification, the CoW Protocol settlement contract would call the ERC-1271 ",(0,o.kt)("inlineCode",{parentName:"p"},"isValidSignature")," function implemented in the Safe Smart Contract and:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Pass in the concatenated owner ECDSA signatures as the ",(0,o.kt)("inlineCode",{parentName:"li"},"signature")," bytes"),(0,o.kt)("li",{parentName:"ol"},"The Safe would, for each signature decoded from the ",(0,o.kt)("inlineCode",{parentName:"li"},"signature")," bytes:"),(0,o.kt)("li",{parentName:"ol"},"ECDSA recover the signer address"),(0,o.kt)("li",{parentName:"ol"},"Verify that the signer is an owner"),(0,o.kt)("li",{parentName:"ol"},"And finally, to verify the signature, it would make sure that the total number of signatures it got is greater than the owner threshold.")),(0,o.kt)("p",null,"We see that this already works today in CoW Protocol, for example order ",(0,o.kt)("a",{parentName:"p",href:"https://barn.explorer.cow.fi/goerli/orders/0x71cff2646c6ca7b26844fdada874db8f20ff10cc831ffc8ba381b77dc185279fd64d6de7a7630d7a63f133b882ac44427d88555562e77d0e"},(0,o.kt)("inlineCode",{parentName:"a"},"71cff264")),"."))}p.isMDXComponent=!0}}]);